---
title: NOAA Storm Database - Impact with Respect to Population Health and Economic
  Consequences.
output:
  html_document:
    fig_height: 8
    fig_width: 9
    keep_md: yes
date: "Friday, May 08, 2015"
---

## Synopsis

This report is an analysis of the U.S. National Oceanic and Atmospheric Administration's (NOAA) Storm Database. The report focuses on two specific aspects of the data: first, the report determines the impact to population health and second, the report reviews the economic impact.


## Data Source

At the time of this report, the data set is located at [this location](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) (http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2).

For more information on this data set, the following documentation is available:-

* National Weather Service Storm Data [Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

* National Climatic Data Center Storm Events [FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)


## Import Packages

```{r, echo=FALSE, warning=FALSE}
# Here the necessary libraries are preloaded. Later in the code, they will be loaded again so 
# readers can see where libraries are used. However by preloading here using suppresMessages() 
# funciton  and setting echo=FALSE,The messages generated by the libraries will not appear 
# in the final markdown file
suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressMessages(library(tidyr))
suppressMessages(library(RColorBrewer))
```

The following packages are used for analysis and visualization in this report. 

```{r, warning=FALSE}
library(dplyr)  # For data manipulation and grouping.
library(ggplot2)  # For plotting
library(tidyr)  # For creating tidy data
library(RColorBrewer)  # For charting color palette
```


## Data Proccessing

Download the data file and load into a data frame. 

```{r, cache=TRUE, warning=FALSE}
url <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
filename <- "repdata-data-StormData.csv.bz2"
download.file(url, filename, cacheOK = TRUE)
storm.data <- read.csv(filename, stringsAsFactors=FALSE)
```


It can be observed that the data set has more than 900 thousand entries.

```{r}
dim(storm.data)
```

In order to make the data set more manageable, unnecessary data will be removed. 

#### Extracting The Health Impact Data

To answer the question related to events harmful to population health, a data frame called **storm.data.health** is created where the number of fatalities and injuries is zero are removed. 

```{r}
storm.data.health <- select(storm.data, EVTYPE, FATALITIES, INJURIES)
storm.data.health <- filter(storm.data.health, FATALITIES > 0 & INJURIES > 0)
```

The population health data looks like the following:-

```{r}
tbl_df(storm.data.health)
```

#### Extracting The Economic Impact Data

To answer the question related to events with the largest economic consequences, a data frame called **storm.data.dmg** is created where the number of property and crop damage is zero are removed. 

```{r}
storm.data.dmg <- select(storm.data, EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)
storm.data.dmg <- filter(storm.data.dmg, PROPDMG > 0 & CROPDMG > 0)
```

The economic consequences data looks like the following:-

```{r}
tbl_df(storm.data.dmg)
```

#### Combining Similar Event Types

By observing different event types, it can be seen that there are some similar events.

```{r}
unique(storm.data.health$EVTYPE)
```

For example, there are multiple events types with "FLOOD", "FOG", THUNDERSTORM", "WIND", "HEAT" or "HURRICANE" in the name.

For the purpose of this analysis, these event types will be combined in the **storm.data.health** data frame.

```{r}
storm.data.health$EVTYPE <- sapply(storm.data.health$EVTYPE, function(x) ifelse(grepl("HURRICANE", x, ignore.case = TRUE),"HURRICANE",x))
storm.data.health$EVTYPE <- sapply(storm.data.health$EVTYPE, function(x) ifelse(grepl("FLOOD", x, ignore.case = TRUE),"FLOOD",x))
storm.data.health$EVTYPE <- sapply(storm.data.health$EVTYPE, function(x) ifelse(grepl("THUNDERSTORM", x, ignore.case = TRUE),"THUNDERSTORM",x))
storm.data.health$EVTYPE <- sapply(storm.data.health$EVTYPE, function(x) ifelse(grepl("FOG", x, ignore.case = TRUE),"FOG",x))
storm.data.health$EVTYPE <- sapply(storm.data.health$EVTYPE, function(x) ifelse(grepl("WIND", x, ignore.case = TRUE),"WIND",x))
storm.data.health$EVTYPE <- sapply(storm.data.health$EVTYPE, function(x) ifelse(grepl("HEAT", x, ignore.case = TRUE),"HEAT",x))

```

Repeat for the **storm.data.dmg** data frame.

```{r}
storm.data.dmg$EVTYPE <- sapply(storm.data.dmg$EVTYPE, function(x) ifelse(grepl("HURRICANE", x, ignore.case = TRUE),"HURRICANE",x))
storm.data.dmg$EVTYPE <- sapply(storm.data.dmg$EVTYPE, function(x) ifelse(grepl("FLOOD", x, ignore.case = TRUE),"FLOOD",x))
storm.data.dmg$EVTYPE <- sapply(storm.data.dmg$EVTYPE, function(x) ifelse(grepl("THUNDERSTORM", x, ignore.case = TRUE),"THUNDERSTORM",x))
storm.data.dmg$EVTYPE <- sapply(storm.data.dmg$EVTYPE, function(x) ifelse(grepl("FOG", x, ignore.case = TRUE),"FOG",x))
storm.data.dmg$EVTYPE <- sapply(storm.data.dmg$EVTYPE, function(x) ifelse(grepl("WIND", x, ignore.case = TRUE),"WIND",x))
storm.data.dmg$EVTYPE <- sapply(storm.data.dmg$EVTYPE, function(x) ifelse(grepl("HEAT", x, ignore.case = TRUE),"HEAT",x))
```


## Results

#### **Question 1:** Which types of events are most harmful with respect to population health?

First, the data for fatal events will be grouped together and arranged by number of fatalities in descending order.

```{r}
events.fatal <- storm.data.health %>% group_by(EVTYPE) %>% 
  summarise(fatal=sum(FATALITIES)) %>%
  arrange(desc(fatal))
```

The top 15 fatal events will be used in this analysis.
```{r}
events.fatal <- head(events.fatal, 15)
tbl_df(events.fatal)
```


Next, the data for injury events are grouped and arranged by the number of injuries in descending order.

```{r}
events.injury <- storm.data.health %>% group_by(EVTYPE) %>% 
  summarise(injury=sum(INJURIES)) %>%
  arrange(desc(injury))
```


The top 15 injury events will be used in this analysis.

```{r}
events.injury <- head(events.injury, 15)
tbl_df(events.injury)
```

To chart these data frames, merge the injury and fatal data frames.

```{r}
events.fatal.injury <- merge(events.injury, events.fatal, all.x=TRUE, by.x="EVTYPE")
events.fatal.injury <- arrange(events.fatal.injury, desc(injury))
names(events.fatal.injury) <- c("EVTYPE", "Injury", "Fatal")
```

This results in the following data:-

```{r}
tbl_df(events.fatal.injury)
```

In order to chart the results on the same panel plot, the data will be converted into a "long" format.

```{r}
events.fatal.injury.long <- events.fatal.injury %>% gather(impact, number, Injury:Fatal )
events.fatal.injury.long
```

**Note:** The y axis on this panel plot is using a logarithmic scale. This is done because the numbers for tornadoes greatly exceed the other event types. 

```{r, warning=FALSE, fig.height=10}
plot <- ggplot(data=events.fatal.injury.long, aes(x=EVTYPE, y= number))
plot <- plot + geom_bar(fill="steelblue", stat="identity")
plot <- plot + scale_y_log10()
plot <- plot + ggtitle("Figure 1: Number of Injuries and Fatalities (Log scale)")
plot <- plot + ylab("Number of casualties (Log)") + xlab("Weather Event")
labels <- events.fatal.injury$EVTYPE
plot <- plot + scale_x_discrete(limits=labels)
plot <- plot + facet_grid(impact ~. , scales="free_y")
plot <- plot + theme(axis.text.x = element_text(angle = 45, hjust = 1))
plot <- plot + geom_text(aes(label=number), vjust=-0.2, color="steelblue", size=3)
plot
```


Plotting The data as a scatter plot shows the relationship between injuries and fatalities for each weather event type.

**Note:** First set NA values to 0. Otherwise, the NA rows will be dropped from the plot. 

```{r}
events.fatal.injury$Fatal <- sapply(events.fatal.injury$Fatal, function(x) ifelse(is.na(x),0,x))
```

**Note:** The axes in this plot is using a logarithmic scale. This is done because the numbers for tornadoes greatly exceed the other event types.

```{r, warning=FALSE}
colourCount = length(unique(events.fatal.injury$EVTYPE))
getPalette = colorRampPalette(brewer.pal(12, "Dark2"))

plot <- ggplot(data = events.fatal.injury, aes(x=Injury, y=Fatal, color=getPalette(colourCount)))
plot <- plot + geom_point(size = 2)
plot <- plot + scale_y_log10(limits=c(-100, 1e4)) + scale_x_log10()
plot <- plot + ggtitle("Figure 2: Relationship between Injuries and Fatalities Per Weather Event Type (Log scale)")
plot <- plot + geom_text(aes(label=EVTYPE), size = 3, hjust= 0.5,vjust= -1.5) 
plot <- plot + scale_color_discrete(guide = FALSE)
plot
```

**Conclusion:** It is clear from both of the charts that the most harmful weather events with respect to population health are **tornados** with **excessive heat** the second most harmful. 

----------------------------------------------

#### **Question 2:** Which types of events have the greatest economic consequences?

The data set contains columns called PROPDMGEXP and CROPDMGEXP which list a alphanumeric character indicating the magnitude of the number in the PROPDMG and CROPDMG columns. For the purposes of this report, "K"" is used for thousands, "M" for millions, and "B" for billions.

In addition, for numeric values, they are taken as powers of 10. For example "7" is taken to mean 10<sup>7</sup>. 

The PROPDMGEXP and CROPDMGEXP columns also contain ambiguous characters like "+", "-" and "?"

````{r}
x <- filter(storm.data.dmg, grepl("\\+|\\-|\\?", PROPDMGEXP))
dim(x)
```

However, in the filtered set the quantity of these ambiguous characters is zero and hence they as well as blanks are set to 0 for the purposes of this report. 

```{r}
damage.exp <- c("K"=10^3, "M"=10^6, "B"=10^9, "m"=10^6, "+"=0, " "=0,
                   "0"=0, "5"=10^5, "6"=10^6, "?"=0, "4"=10^4, "2"=10^2, 
                   "3"=10^3, "h"=10^2, "7"=10^7, "H"=10^2, "-"=0, "1"=10, "8"=10^8)

storm.data.dmg$PROPDMGEXP.multipier <- damage.exp[storm.data.dmg$PROPDMGEXP]
storm.data.dmg$CROPDMGEXP.multipier <- damage.exp[storm.data.dmg$CROPDMGEXP]
```

Multiply the PROPDMG and CROPDMG columns with the PROPDMGEXP and CROPDMGEXP columns and then add together for the total cost of that event. Also, missing values are set to 0.

```{r}
storm.data.dmg$PROPDMG.1 <- storm.data.dmg$PROPDMG * storm.data.dmg$PROPDMGEXP.multipier
storm.data.dmg$PROPDMG.1 <- sapply(storm.data.dmg$PROPDMG.1, function(x) ifelse(is.na(x),0,x))  # Set missing values to 0

storm.data.dmg$CROPDMG.1 <- storm.data.dmg$CROPDMG * storm.data.dmg$CROPDMGEXP.multipier
storm.data.dmg$CROPDMG.1 <- sapply(storm.data.dmg$CROPDMG.1, function(x) ifelse(is.na(x),0,x))  # Set missing values to 0

storm.data.dmg <- storm.data.dmg %>% mutate(DMG = PROPDMG.1 + CROPDMG.1 )
```


Group the data by event type using the sum of the damage cost and take the top 15 event types. 

```{r}
grouped.damage <- storm.data.dmg %>% group_by(EVTYPE) %>%  
                            summarise(Property.Damage=sum(DMG))%>%
                            arrange(desc(Property.Damage))
grouped.damage <- head(grouped.damage, 15)
tbl_df(grouped.damage)
```

Plot a bar chart of the result

```{r}
plot <- ggplot(data=grouped.damage, aes(x=EVTYPE, y=Property.Damage))
plot <- plot + geom_bar(fill="aquamarine3", stat="identity")
plot <- plot + ggtitle("Figure 3: Economic Impact Caused by Weather Events")
plot <- plot + ylab("Damage Cost in USD") + xlab("Weather Event")
labels <- grouped.damage$EVTYPE
plot <- plot + scale_x_discrete(limits=labels)
plot <- plot + theme(axis.text.x = element_text(angle = 45, hjust = 1))
plot

```

**Conclusion:** From this analysis it can be observed that the weather events with the biggest impact with respect to economic consequences are floods and hurricanes.  


## Analysis Environment
This analysis was conducted in the following environment.
```{r}
sessionInfo()
```
