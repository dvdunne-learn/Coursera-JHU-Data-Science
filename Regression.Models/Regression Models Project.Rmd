---
title: "Coursera Regression Project"
output:
  html_document:
    keep_md: yes
  pdf_document: default
---

```{r, echo=FALSE}
# Here the necessary libraries are preloaded. Later in the code, they will be loaded again so 
# readers can see where libraries are used. However by preloading here using suppresMessages() 
# funciton  and setting echo=FALSE,The messages generated by the libraries will not appear 
# in the final markdown file
suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(datasets)))
suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(pander)))
suppressWarnings(suppressMessages(library(gridExtra)))
```

# Executive Summary

This report is based on data from automobile industry magazine Motor Trend. The report examines a data set of a collection of cars to explore the relationship between a set of variables and miles per gallon (MPG). The report specifically aims to answer whether automatic transmission is better for MPG compared to manual and to quantify that difference.

**Note:** This report was written as an R Markdown file and converted to PDF using **knitr version 1.11**.

### Exploratory Data Analysis
```{r} 
library(datasets); library(dplyr)  # load libraries
data("mtcars")  # load in the mtcars dataset (part of )
auto <- filter(mtcars, am == 0); mean.mpg.auto <- mean(auto$mpg)  # mean: auto cars
manual <- filter(mtcars, am == 1); mean.mpg.man <- mean(manual$mpg)  # mean: manual cars
```
The mean MPG for automatic transmission cars is found to be **`r round(mean.mpg.auto, 2)`** whereas the mean MPG for manual transmission cars is **`r round(mean.mpg.man, 2)`**. So it would appear that manual transmission cars are better for MPG. See **Figure 1** in the Appendix for a box plot illustrating these results.

Next a matrix of scatter plots and correlations is done on all the variables in the data set to determine if there are other confounding variables that could explain the initial results. See See **Figure 2** in the Appendix for the scatter plot matrix.

```{r}
mt.cor = cor(mtcars)
set.caption("Corrolation Table")
panderOptions("table.split.table", 130); panderOptions("digits", 3)
pander(mt.cor[1,])
```

The correlation results indicate that mpg is correlated with cyl, disp, hp and wt. Since displacement (disp) would be dependent on the number of cylinders (cyl), only disp, hp and wt will be used in the rest of the analysis. 

### Regression Analysis

First a linear regression is conducted to observe the direct relationship between mpg and transmission.

```{r}
fit <- lm(mpg ~ am, data = mtcars)
fit$coefficients
```
See **Figure 3 ** in the appendix for the full output from the lm command.

From this regression, the intercept of `r round(fit$coefficients[1], 3)` is the average MPG for an automatic car (we saw this earlier) and the coefficient indicates that a manual car has an increase of `r round(fit$coefficients[2], 3)` MPG. However, the R^2^ value of `r round(summary(fit)$r.squared, 3)` is the percentage of variation explained by the regression model which is not very high.

Next a nested model test is done with the added terms wt, hp and disp.

```{r, results="hide"}
fit2 <- lm(mpg ~ am + wt, data = mtcars)  # am + wt
fit3 <- lm(mpg ~ am + wt + hp, data = mtcars)  # am + wt + hp
fit4 <- lm(mpg ~ am + wt + hp + disp, data = mtcars)  # am + wt + hp + disp
anv <- anova(fit, fit2, fit3, fit4)
```
See **Figure 4 ** in the appendix for the full output from the anova command.

The p-values from the nested model test indicate that the added model fit3 terms are significant over model fit2 and the model fit2 terms are significant over the original model. However, the added term (disp) in model fit4 is not significant in our tests.

```{r}
fit3$coefficients
summary(fit3)$r.squared
```

Summarizing the coefficients of model fit3 shows that when wt and hp are included in the model, manual transmission cars have an mpg increase of **`r round(fit3$coefficients[2], 3)`**. Also, this time the R^2^ value of `r round(summary(fit3)$r.squared, 3)`.

### Residuals

Lastly, the residuals should exhibit no trends and be normally distributed. The residuals vs. fitted values plot and the Normal Q-Q plot indicate that the residuals do not show a pattern and that they are close to being normally distributed. (See **Figure 5** in the appendix.)

# Conclusion

***Is an automatic or manual transmission better for MPG?***

It appears that manual transmission cars are better for MPG compared to automatic cars. However when modeled with confounding variables like displacement, HP and weight, the difference is not as significant. 

 ***Quantify the MPG difference between automatic and manual transmissions***

Analysis shows that when only transmission was used in the model manual cars have an mpg increase of **`r round(fit$coefficients[2], 3)`**. However, when variables wt and hp are included, the manual car advantage drops to **`r round(fit3$coefficients[2], 3)`** with other variables contributing to the effect.



\pagebreak

# Appendix

### Figure 1: Boxplot of MPG as a function of transmission

```{r, echo=FALSE, fig.height= 3, fig.width=3}
#Make plot of mpg ~ automatic & mpg ~ manual
plot <- ggplot(mtcars, aes(x=factor(am), y=mpg)) 
plot <- plot + geom_boxplot(fill="salmon")
#plot <- plot + ggtitle("Figure 1: Boxplot of MPG as a function of transmission")
plot <- plot + ylab("MPG") + xlab("Transmission")
plot <- plot + scale_x_discrete(breaks=c(0, 1), labels=c("Auto", "Manual"))
plot
```

### Figure 2: Cars Scatterplot Matrix

```{r, echo=FALSE}
#Make scatter plot for all variables
#pairs(mtcars, lower.panel=panel.smooth, main="Figure 2: Cars Scatterplot Matrix")
pairs(mtcars, lower.panel=panel.smooth)
```

### Figure 3: Output from linear model mpg ~ am

```{r, echo=FALSE}
fit <- lm(mpg ~ am, data = mtcars)
summary(fit)
```


### Figure 4: Output from nested models

```{r, echo=FALSE}
fit2 <- lm(mpg ~ am + wt, data = mtcars)  # am + wt
fit3 <- lm(mpg ~ am + wt + hp, data = mtcars)  # am + wt + hp
fit4 <- lm(mpg ~ am + wt + hp + disp, data = mtcars)  # am + wt + hp + disp
anova(fit, fit2, fit3, fit4)
```


### Figure 5: Residuals plot 

```{r, echo=FALSE}
fit3 <- lm(mpg ~ am + wt + hp, data = mtcars)

r <- residuals(fit3)
yh <- predict(fit3)
scatterplot <- function(x,y, title="", xlab="", ylab="") {
  d <- data.frame(x=x,y=y)
  p <- ggplot(d, aes(x=x,y=y)) + geom_point() + ggtitle(title) + xlab(xlab) + ylab(ylab)
  return(p)
}

p1 <- scatterplot(yh,r,
                  title="Residuals vs Fitted",
                  xlab="Fitted values",
                  ylab="Residuals")
p1 <- p1 +geom_hline(yintercept=0)+geom_smooth(se=FALSE)

s <- sqrt(deviance(fit3)/df.residual(fit3))
rs <- r/s

qqplot <- function(y,
                   distribution=qnorm,
                   title="Normal Q-Q",
                   xlab="Theretical Quantiles",
                   ylab="Sample Quantiles") {
  require(ggplot2)
  x <- distribution(ppoints(y))
  d <- data.frame(x=x, y=sort(y))
  p <- ggplot(d, aes(x=x, y=y)) +
    geom_point() +
    geom_line(aes(x=x, y=x)) +
    ggtitle(title) +
    xlab(xlab) +
    ylab(ylab)
  return(p)
}

p2 <- qqplot(rs, ylab="Standardized residuals")

sqrt.rs <- sqrt(abs(rs))
p3 <- scatterplot(yh,sqrt.rs,
                  title="Scale-Location",
                  xlab="Fitted values",
                  ylab=expression(sqrt("Standardized residuals")))
p3 <- p3 + geom_smooth(se=FALSE)

hii <- lm.influence(fit3, do.coef = FALSE)$hat
p4 <- scatterplot(hii,rs)
p4 <- p4+
  geom_hline(yintercept=0)+
  geom_smooth(se=FALSE) +
  geom_text(aes(x=min(hii)+diff(range(hii))*0.3,
                y=min(rs)+diff(range(rs))*0.04,
                label="--   Cook's distance", size=3))+
  theme(legend.position="none")

grid.arrange(p1,p2,p3,p4, ncol=2)
```
